<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>代码编辑器</title>
  <link rel="stylesheet" href="./css/main.css?v=1.0">
</head>
<body>
  <div id="app">
    <div class="code">
      <div class="nav">
        <ul>
          <li>
            <select name="" id="">
              <option value="">网页</option>
            </select>
          </li>
          <li class="active" data-index="1">
            <span>html</span>
          </li>
          <li data-index="2">
            <span>css</span>
          </li>
          <li data-index="3">
            <span>js</span>
          </li>
          <li>
            <select name="" id="theme">
              <option value="monokai">monokai</option>
              <option value="ambiance">ambiance</option>
              <option value="chaos">chaos</option>
              <option value="chrome">chrome</option>
              <option value="dracula">dracula</option>
              <option value="tomorrow">tommorrow</option>
              <option value="solarized_light">solarized_light</option>
              <option value="solarized_dark">solarized_dark</option>
            </select>
          </li>
          <li class="preview-btn">
            <span>预览</span>
          </li>
        </ul>
      </div>
      <div class="editor-group-web">
        <div id="editor-html" class="editor"></div>
        <div id="editor-css" class="editor"></div>
        <div id="editor-js" class="editor"></div> 
      </div>
      <div class="symbol-input">
        <!-- <input type="text" class="toggle-btn" value="&theta;"> -->
        <div class="toggle-btn">&theta;</div>
        <!-- <input type="text" class="tab-btn" value="tab"> -->
        <div class="tab-btn">tab</div>
      </div>
    </div>
    <textarea id="v-input">v</textarea>
    <div class="preview">
      <iframe id="window" src="./preview.html" frameborder="0"></iframe>
      <div class="toolbar">
        <div class="close-preview-btn"><img src="./images/back.gif" alt=""></div>
        <div class="refresh-preview-btn"><img src="./images/refresh.gif" alt=""></div>
      </div>
    </div>
  </div>
  <script src="./lib/emmet.js"></script>
  <script src="./node_modules/ace-builds/src-min/ace.js"></script>
  <script src="./node_modules/ace-builds/src-min/ext-emmet.js"></script>
  <script src="./node_modules/ace-builds/src-min/ext-language_tools.js"></script>
  <script src="./js/render.js"></script>
  <script>
    // 获取所有html-Element
    let previewBtn = document.querySelector('.preview-btn')
    , preview = document.querySelector('.preview')
    , code = document.querySelector('.code')
    , editorGroupWeb = document.querySelector('.editor-group-web')
    , editorWebList = editorGroupWeb.querySelectorAll('.editor')
    , navList = document.querySelector('.nav').querySelectorAll('li')
    , iframe = document.querySelector('#window')
    , symbolInput = document.querySelector('.symbol-input')
    , symbolToggleBtn = document.querySelector('.toggle-btn')
    , tabBtn = document.querySelector('.tab-btn')
    , aceCursor = document.querySelector('.ace_cursor')
    , theme = document.querySelector('#theme')
    , vInput = document.querySelector('#v-input')
    , closePreviewBtn = document.querySelector('.close-preview-btn') 
    , refreshPreviewBtn = document.querySelector('.refresh-preview-btn') 
    // 打开预览
    previewBtn.addEventListener('click', () => {
      render()
      preview.style.display = 'block'
      code.style.display = 'none'
      iframe.contentWindow.location.reload()
    })
    // 返回和刷新
    closePreviewBtn.addEventListener('click', function() {
      preview.style.display = 'none'
      code.style.display = 'block'
    })
    refreshPreviewBtn.addEventListener('click', function() {
      iframe.contentWindow.location.reload()
    })
    // 渲染编辑器
    ace.require('ace/ext/language_tools');
    const editor = {
      html: ace.edit("editor-html"),
      css: ace.edit("editor-css"),
      js: ace.edit("editor-js"),
      current: null
    }
    editor.current = editor.html
    // 设置主题模式及属性
    editor.html.setTheme('ace/theme/monokai')
    editor.css.setTheme('ace/theme/monokai')
    editor.js.setTheme('ace/theme/monokai')
    editor.html.session.setMode("ace/mode/html")
    editor.html.setOptions({
      enableBasicAutocompletion: true,
      enableSnippets: true,
      enableLiveAutocompletion: true,
      enableEmmet: true
    })
    editor.css.session.setMode("ace/mode/css")
    editor.css.setOptions({
      enableBasicAutocompletion: true,
      enableSnippets: true,
      enableLiveAutocompletion: true
    })
    editor.js.session.setMode("ace/mode/javascript")
    editor.js.setOptions({
      enableBasicAutocompletion: true,
      enableSnippets: true,
      enableLiveAutocompletion: true
    })
    // 代码记忆
    if (localStorage.getItem('code-html')) {
      editor.html.setValue(localStorage.getItem('code-html'))
    }
    if (localStorage.getItem('code-css')) {
      editor.css.setValue(localStorage.getItem('code-css'))
    }
    if (localStorage.getItem('code-js')) {
      editor.js.setValue(localStorage.getItem('code-js'))
    }
    // 点击tab栏切换编辑器
    let currentIndex = '1'
    navList.forEach(nav => {
      nav.addEventListener('click', () => {
        let index = nav.getAttribute('data-index')
        if (!index) return
        if (currentIndex != index) {
          navList[currentIndex].setAttribute('class', '')
          navList[index].setAttribute('class', 'active')
          currentIndex = index
        }
        editorWebList.forEach(editor => {
          editor.style.transform = "translateX(-"+(index-1)*100+"%)"
        })
        switch (currentIndex) {
          case '1':
            editor.current = editor.html
            break
          case '2':
            editor.current = editor.css
            break
          case '3':
            editor.current = editor.js
            break
        }
      })
    })
    vInput.oncopy = function() { return false }
    // 编辑器失焦时键盘输入
    vInput.addEventListener('input', function() {
      if (this.value.length < 1) {
        editor.current.execCommand('backspace')
      } else {
        editor.current.insert(this.value.substr(1))
      }
      console.log(this.value)
      this.value = "v"
    })
    vInput.addEventListener('keydown', function() {
      console.log(event.key)
      if (event.key == 'Tab') {
        editor.current.indent()
        setTimeout(() => {
          vInput.focus()
        }, 100)
      }
    })
    // 渲染符号
    symbolList = ['`', '!', '@', '$', '%', '^', '&', '*', '(', ')', 
      '-', '_', '+', '=', '<', '>', ',', '#', '?', '/', '[', ']', '{', '}', '|', '\\', "\:", "\;"];
    // 没有 . 和 ~
    symbolList.forEach(item => {
      let symbolItem = document.createElement('div')
      symbolItem.innerText = item
      symbolItem.addEventListener('click', () => {
        editor.current.insert(item)
        editor.current.onFocus()
        vInput.focus()
      })
      symbolInput.appendChild(symbolItem)
    })
    // 符号输入表展开与收起
    symbolToggleBtn.addEventListener('click', function() {
      let unflodHeight = '75px'
      let flogHeight = '50px'
      if (symbolInput.style.height === unflodHeight) {
        code.style.paddingBottom = flogHeight
        symbolInput.style.height = flogHeight
      } else {
        code.style.paddingBottom = unflodHeight
        symbolInput.style.height = unflodHeight
      }
      vInput.focus()
    })
    // 模拟tab键 主要为了emmet 但是没用
    tabBtn.addEventListener('click', () => {
      editor.current.indent()
      editor.current.onFocus()
      vInput.focus()
    })
    // 修改主题
    theme.addEventListener('change', function() {
      let themeName = this.value
      editor.html.setTheme('ace/theme/'+themeName)
      editor.css.setTheme('ace/theme/'+themeName)
      editor.js.setTheme('ace/theme/'+themeName)
    })
  </script>
</body>
</html>