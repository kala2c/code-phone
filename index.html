<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>代码编辑器</title>
  <link rel="stylesheet" href="./css/main.css?v=1.0">
</head>
<body>
  <div id="app">
    <div class="code">
      <div class="nav">
        <ul>
          <li>
            <select name="" id="">
              <option value="">网页</option>
            </select>
          </li>
          <li class="active" data-index="1">
            <span>html</span>
          </li>
          <li data-index="2">
            <span>css</span>
          </li>
          <li data-index="3">
            <span>js</span>
          </li>
          <li>
            <select name="" id="theme">
              <option value="monokai">monokai</option>
              <option value="ambiance">ambiance</option>
              <option value="chaos">chaos</option>
              <option value="chrome">chrome</option>
              <option value="dracula">dracula</option>
              <option value="tommorrow">tommorrow</option>
              <option value="solarized_light">solarized_light</option>
              <option value="solarized_dark">solarized_dark</option>
            </select>
          </li>
          <li class="preview-btn">
            <span>预览</span>
          </li>
        </ul>
      </div>
      <div class="editor-group-web">
        <div id="editor-html" class="editor"></div>
        <div id="editor-css" class="editor"></div>
        <div id="editor-js" class="editor"></div> 
      </div>
      <div class="symbol-input">
        <div class="toggle-btn">&theta;</div>
        <div class="tab-btn">tab</div>
      </div>
    </div>
    <div class="preview">
      <iframe id="window" src="" frameborder="0"></iframe>
    </div>
  </div>
  <script src="./lib/emmet.js"></script>
  <script src="./node_modules/ace-builds/src-min/ace.js"></script>
  <script src="./node_modules/ace-builds/src-min/ext-emmet.js"></script>
  <script src="./node_modules/ace-builds/src-min/ext-language_tools.js"></script>
  <script src="./node_modules/vconsole/dist/vconsole.min.js"></script>
  <script>
    // 获取所有html-Element
    let previewBtn = document.querySelector('.preview-btn')
    , preview = document.querySelector('.preview')
    , code = document.querySelector('.code')
    , editorGroupWeb = document.querySelector('.editor-group-web')
    , editorWebList = editorGroupWeb.querySelectorAll('.editor')
    , navList = document.querySelector('.nav').querySelectorAll('li')
    , iframe = document.querySelector('#window')
    , symbolInput = document.querySelector('.symbol-input')
    , symbolToggleBtn = document.querySelector('.toggle-btn')
    , tabBtn = document.querySelector('.tab-btn')
    , aceCursor = document.querySelector('.ace_cursor')
    , theme = document.querySelector('#theme')
    // 打开预览
    let vConsole = null // vConsole
    previewBtn.addEventListener('click', () => {
      preview.style.display = 'block'
      code.style.display = 'none'
      // 将代码拼装渲染到iframe
      render()
      // 启动vConsole
      if (vConsole === null) {
        vConsole = new VConsole();
        console.log("command框输入“b()”后点击OK关闭预览")
      } else {
        vConsole.showSwitch()
      }
    })
    // 渲染编辑器
    ace.require('ace/ext/language_tools');
    const editor = {
      html: ace.edit("editor-html"),
      css: ace.edit("editor-css"),
      js: ace.edit("editor-js")
    };
    // 设置主题模式及属性
    editor.html.setTheme('ace/theme/monokai')
    editor.css.setTheme('ace/theme/monokai')
    editor.js.setTheme('ace/theme/monokai')
    editor.html.session.setMode("ace/mode/html")
    editor.html.setOptions({
      enableEmmet: true
    })
    editor.css.session.setMode("ace/mode/css")
    editor.css.setOptions({
      enableBasicAutocompletion: true,
      enableSnippets: true,
      enableLiveAutocompletion: true
    })
    editor.js.session.setMode("ace/mode/javascript")
    editor.js.setOptions({
      enableBasicAutocompletion: true,
      enableSnippets: true,
      enableLiveAutocompletion: true
    })
    function b() {
      preview.style.display = 'none'
      code.style.display = 'block'
      vConsole.hideSwitch()
      vConsole.hide()
    }
    function render() {
      iframe.contentDocument.head.innerHTML = ""
      iframe.contentDocument.body.innerHTML = ""
      // let html = editorWebList[0].querySelector('.ace_content').innerText
      // let style = "<style>"+editorWebList[1].querySelector('.ace_content').innerText+"</style>"
      // let script = "<script>"+editorWebList[2].querySelector('.ace_content').innerText+"</scr"+"ipt>"
      let html = editor.html.getValue()
      let style = "<style>"+editor.css.getValue()+"</style>"
      // script闭合便签要拆开 不然会报错 
      let script = "<script>"+editor.js.getValue()+"</scr"+"ipt>"
      iframe.contentDocument.write(html)
      if (iframe.contentWindow.document.head) {
        iframe.contentWindow.document.head.innerHTML = style
      }
      iframe.contentDocument.writeln(script)
    }
    let currentIndex = '1'
    navList.forEach(nav => {
      nav.addEventListener('click', () => {
        let index = nav.getAttribute('data-index')
        if (!index) return
        if (currentIndex != index) {
          navList[currentIndex].setAttribute('class', '')
          navList[index].setAttribute('class', 'active')
          currentIndex = index
        }
        editorWebList.forEach(editor => {
          editor.style.transform = "translateX(-"+(index-1)*100+"%)"
        })
      })
    })
    // 渲染符号
    symbolList = ['`', '!', '@', '$', '%', '^', '&', '*', '(', ')', 
      '-', '_', '+', '=', '<', '>', ',', '.', '?', '/', '[', ']', '{', '}', '|', '\\', "\:", "\;"];
    // 没有 # ~
    symbolList.forEach(item => {
      let div = document.createElement('div')
      div.innerText = item
      div.addEventListener('click', () => {
        console.log(currentIndex)
        switch (currentIndex) {
          case '1':
            editor.html.insert(item)
            editor.html.onFocus()
            break
          case '2':
            editor.css.insert(item)
            editor.css.onFocus()
            break
          case '3':
            editor.js.insert(item)
            editor.css.onFocus()
            break
        }
      })
      symbolInput.appendChild(div)
    })
    // 符号输入表展开与收起
    symbolToggleBtn.addEventListener('click', function() {
      let unflodHeight = '75px'
      let flogHeight = '50px'
      if (symbolInput.style.height === unflodHeight) {
        code.style.paddingBottom = flogHeight
        symbolInput.style.height = flogHeight
      } else {
        code.style.paddingBottom = unflodHeight
        symbolInput.style.height = unflodHeight
      }
    })
    // 模拟tab键 主要为了emmet
    tabBtn.addEventListener('click', () => {
      switch (currentIndex) {
        case 1:
          editor.html.indent()
          editor.html.onFocus()
          break
        default:
          editor.css.indent()
          editor.css.onFocus()
          break
      }
    })
    // 修改主题
    theme.addEventListener('change', function() {
      let themeName = this.value
      editor.html.setTheme('ace/theme/'+themeName)
      editor.css.setTheme('ace/theme/'+themeName)
      editor.js.setTheme('ace/theme/'+themeName)
    })
  </script>
</body>
</html>